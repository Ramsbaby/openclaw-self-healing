#!/bin/bash
# Weekly Review Collector for V5.0 Layer 3
# =========================================
# ì§€ë‚œ 7ì¼ê°„ì˜ self-review ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ìš”ì•½
# Node.js ê¸°ë°˜ YAML íŒŒì‹± (grepë³´ë‹¤ ì•ˆì „)
# =========================================

set -euo pipefail

REVIEW_DIR=~/openclaw/memory/self-review

echo "# ì£¼ê°„ ìê¸°í‰ê°€ ìš”ì•½ (V5.0 Layer 3)"
echo "# ìƒì„±ì¼: $(date '+%Y-%m-%d %H:%M')"
echo "# ë¶„ì„ ëŒ€ìƒ: ì§€ë‚œ 7ì¼"
echo ""

# Node.jsë¡œ YAML íŒŒì‹± (js-yaml ì—†ì´ ê°„ë‹¨í•œ íŒŒì‹±)
node << 'NODEJS_SCRIPT'
const fs = require('fs');
const path = require('path');

const reviewDir = process.env.HOME + '/openclaw/memory/self-review';

// ì§€ë‚œ 7ì¼ ë‚ ì§œ ìƒì„±
const dates = [];
for (let i = 0; i < 7; i++) {
  const d = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
  dates.push(d.toISOString().split('T')[0]);
}

let totalReviews = 0;
let scoreSum = 0;
let lowScores = 0;  // < 7ì 
let tooEasyCount = 0;
const problems = [];
const improvements = [];

// ê°„ë‹¨í•œ YAML ê°’ ì¶”ì¶œ (ì •ê·œì‹ ê¸°ë°˜)
function extractValue(content, key) {
  const regex = new RegExp(`^\\s*${key}:\\s*["']?([^"'\\n]+)["']?`, 'm');
  const match = content.match(regex);
  return match ? match[1].trim() : null;
}

function extractNumber(content, key) {
  const val = extractValue(content, key);
  return val ? parseFloat(val) : null;
}

function extractBoolean(content, key) {
  const val = extractValue(content, key);
  return val === 'true';
}

for (const date of dates) {
  const dayDir = path.join(reviewDir, date);
  
  if (!fs.existsSync(dayDir)) continue;
  
  const files = fs.readdirSync(dayDir).filter(f => f.endsWith('.yaml'));
  
  for (const file of files) {
    const content = fs.readFileSync(path.join(dayDir, file), 'utf8');
    totalReviews++;
    
    // ì ìˆ˜ ì¶”ì¶œ
    const score = extractNumber(content, 'score');
    if (score !== null) {
      scoreSum += score;
      if (score < 7) lowScores++;
    }
    
    // í¸í–¥ ì²´í¬
    if (extractBoolean(content, 'am_i_being_too_easy')) {
      tooEasyCount++;
    }
    
    // ë¬¸ì œì  ìˆ˜ì§‘
    const cronName = extractValue(content, 'cron_name');
    const wrong = extractValue(content, 'what_went_wrong');
    const action = extractValue(content, 'next_action');
    
    if (wrong && wrong !== 'ì—†ìŒ' && wrong !== 'N/A') {
      problems.push({ date, cronName, wrong, action });
    }
  }
}

// í†µê³„ ì¶œë ¥
console.log('## ğŸ“Š í†µê³„\n');
console.log(`- ì´ ìê¸°í‰ê°€ ìˆ˜: ${totalReviews}`);
console.log(`- í‰ê·  ì ìˆ˜: ${totalReviews > 0 ? (scoreSum / totalReviews).toFixed(1) : 'N/A'}`);
console.log(`- ëª©í‘œ ë¯¸ë‹¬ (< 7ì ): ${lowScores}`);
console.log(`- ê´€ëŒ€í•¨ ì¸ì • (am_i_being_too_easy): ${tooEasyCount}`);
console.log('');

// ë¬¸ì œì  ëª©ë¡
console.log('## ğŸ”§ ë°œê²¬ëœ ë¬¸ì œì \n');
if (problems.length === 0) {
  console.log('_ë¬¸ì œì  ì—†ìŒ (âš ï¸ ë„ˆë¬´ ê´€ëŒ€í•œ ê²ƒì€ ì•„ë‹Œì§€ í™•ì¸ í•„ìš”)_\n');
} else {
  for (const p of problems.slice(0, 10)) {  // ìµœëŒ€ 10ê°œ
    console.log(`### ${p.date} - ${p.cronName || 'Unknown'}`);
    console.log(`- ë¬¸ì œ: ${p.wrong}`);
    console.log(`- ì•¡ì…˜: ${p.action || 'ì—†ìŒ'}`);
    console.log('');
  }
}

// íŒ¨í„´ ë¶„ì„
console.log('## ğŸ” íŒ¨í„´ ë¶„ì„\n');

// ê°™ì€ ë¬¸ì œ ë°˜ë³µ ì²´í¬
const wrongCounts = {};
for (const p of problems) {
  const key = p.wrong.toLowerCase().substring(0, 30);
  wrongCounts[key] = (wrongCounts[key] || 0) + 1;
}
const repeated = Object.entries(wrongCounts).filter(([k, v]) => v >= 2);
if (repeated.length > 0) {
  console.log('### âš ï¸ ë°˜ë³µë˜ëŠ” ë¬¸ì œ');
  for (const [problem, count] of repeated) {
    console.log(`- "${problem}..." (${count}íšŒ)`);
  }
  console.log('');
}

// ì™¸ë¶€ ê²€ì¦ ì§ˆë¬¸
console.log('## ğŸ¯ Layer 3 ê²€ì¦ ì§ˆë¬¸\n');
console.log('1. ì´ë²ˆ ì£¼ ìê¸°í‰ê°€ë“¤ì´ ë„ˆë¬´ ê´€ëŒ€í–ˆëŠ”ê°€?');
console.log(`   - ê´€ëŒ€í•¨ ì¸ì •ë¥ : ${totalReviews > 0 ? ((tooEasyCount / totalReviews) * 100).toFixed(0) : 0}%`);
console.log('2. ê°™ì€ ì‹¤ìˆ˜ê°€ ë°˜ë³µë˜ê³  ìˆëŠ”ê°€?');
console.log(`   - ë°˜ë³µ íŒ¨í„´: ${repeated.length}ê°œ ë°œê²¬`);
console.log('3. ê°œì„  í•­ëª©ì´ ì‹¤ì œë¡œ ì ìš©ëëŠ”ê°€?');
console.log('4. ë‹¤ìŒ ì£¼ ì§‘ì¤‘í•´ì•¼ í•  ì˜ì—­ì€?');
NODEJS_SCRIPT

echo ""
echo "---"
echo "_Generated by weekly-review-collector.sh (V5.0)_"
